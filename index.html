<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMKM-Desa | Dashboard Regional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass-loading {
            position: relative;
            overflow: hidden;
            background-color: #f3f4f6;
        }
        .glass-loading::after {
            content: "";
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0) 100%);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        
        .product-card { transition: all 0.3s ease; }
        body::-webkit-scrollbar { display: none; }

        /* Style Side Sheet */
        #side-sheet {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sheet-open { transform: translateX(0) !important; }
    </style>
</head>
<body class="bg-[#F8F9FA] overflow-x-hidden">

    <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-lg border-b px-5 py-4">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-2xl font-black text-green-700 leading-none">UMKM<span class="text-orange-500">-Desa</span></h1>
                <p id="current-region" class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-1">Kabupaten Mamuju</p>
            </div>
        </div>

        <div class="flex gap-2">
            <div class="relative flex-1">
                <input type="text" placeholder="Cari produk desa..." class="w-full bg-gray-100 border-none rounded-2xl py-3 px-10 text-sm focus:ring-2 focus:ring-green-500 transition-all">
                <svg class="w-4 h-4 absolute left-4 top-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <button onclick="toggleSheet()" class="bg-green-700 text-white p-3 rounded-2xl shadow-lg active:scale-95 transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
            </button>
        </div>
    </header>

    <main class="p-4 pb-24">
        <div id="product-container" class="grid grid-cols-2 gap-4"></div>

        <div id="skeleton-loader" class="grid grid-cols-2 gap-4 mt-4">
            <script>
                for(let i=0; i<4; i++){
                    document.write(`
                        <div class="bg-white rounded-[2rem] p-3 shadow-sm border border-gray-100">
                            <div class="aspect-square glass-loading rounded-[1.5rem] mb-3"></div>
                            <div class="h-3 glass-loading rounded-full w-3/4 mb-2 mx-1"></div>
                            <div class="h-5 glass-loading rounded-full w-full mx-1"></div>
                        </div>
                    `);
                }
            </script>
        </div>

        <div id="sentinel" class="h-20"></div>
    </main>

    <div id="sheet-overlay" onclick="toggleSheet()" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-300"></div>
    <div id="side-sheet" class="fixed top-0 right-0 bottom-0 w-3/4 bg-white z-[60] shadow-2xl transform translate-x-full p-6 flex flex-col">
        <h2 class="text-xl font-black text-gray-800 mb-6">Pilih Wilayah</h2>
        
        <div class="space-y-4">
            <button onclick="changeRegion('Mamuju', 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSnaM3i5KvBdAtkv2sl5v8W98ncRX2VjLz2lP8w22Iq9LpvZqpFKiAzGvUItbxk6ZdbPUNsB7rRXyoL/pub?gid=0&single=true&output=csv')" class="w-full text-left p-4 rounded-2xl bg-gray-50 hover:bg-green-50 border border-gray-100 hover:border-green-200 transition-all font-bold text-gray-700">üìç Kabupaten Mamuju</button>
            
            <button onclick="changeRegion('Polman', 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGRDIoo5tAGzyJW3K2OfH7J7HS5LBpqLv6GaWQjeALJKNYDk40KK4Yeq-n6WV_gIiqIzDf5SNKQwJZ/pub?gid=0&single=true&output=csv')" class="w-full text-left p-4 rounded-2xl bg-gray-50 hover:bg-green-50 border border-gray-100 hover:border-green-200 transition-all font-bold text-gray-700">üìç Kabupaten Polman</button>
            
            <button onclick="changeRegion('Majene', 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRh5_1vb_8XGETO0iSzapPY11vhxOw485TzcMQzP7T1FliDp_LvLtE3nuGOvFYuFunvRPKWS6A8uwVY/pub?gid=0&single=true&output=csv')" class="w-full text-left p-4 rounded-2xl bg-gray-50 hover:bg-green-50 border border-gray-100 hover:border-green-200 transition-all font-bold text-gray-700">üìç Kabupaten Majene</button>
        </div>

        <button onclick="toggleSheet()" class="mt-auto w-full bg-gray-900 text-white py-4 rounded-2xl font-bold shadow-lg">Tutup</button>
    </div>

    <script>
        const IMG_PREFIX = "https://i.ibb.co.com/";
        let currentUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnaM3i5KvBdAtkv2sl5v8W98ncRX2VjLz2lP8w22Iq9LpvZqpFKiAzGvUItbxk6ZdbPUNsB7rRXyoL/pub?gid=0&single=true&output=csv";
        
        let allData = [];
        let currentIndex = 0;
        const limit = 5;

        const container = document.getElementById('product-container');
        const loader = document.getElementById('skeleton-loader');

        async function fetchCSV(url) {
            container.innerHTML = '';
            allData = [];
            currentIndex = 0;
            loader.classList.remove('hidden');
            
            try {
                const response = await fetch(url);
                const text = await response.text();
                processData(text);
            } catch (err) { console.error(err); }
        }

        function processData(csvText) {
            const rows = csvText.split('\n');
            const headers = rows[0].split(',').map(h => h.trim());
            for (let i = 1; i < rows.length; i++) {
                const currentLine = rows[i].split(',');
                if (currentLine.length < headers.length) continue;
                let obj = {};
                headers.forEach((header, index) => {
                    obj[header] = currentLine[index] ? currentLine[index].trim().replace(/^"|"$/g, '') : "";
                });
                allData.push(obj);
            }
            renderBatch();
        }

        function renderBatch() {
            if (currentIndex >= allData.length) { loader.classList.add('hidden'); return; }
            loader.classList.remove('hidden');
            setTimeout(() => {
                const chunk = allData.slice(currentIndex, currentIndex + limit);
                chunk.forEach(item => {
                    const cardHtml = `
                    <div class="product-card bg-white rounded-[2rem] p-3 shadow-sm border border-gray-50 flex flex-col justify-between">
                        <div>
                            <div class="relative aspect-square rounded-[1.5rem] overflow-hidden mb-3 bg-gray-100">
                                <img src="${IMG_PREFIX}${item.link_thumbnail}" class="w-full h-full object-cover">
                                <div class="absolute bottom-2 left-2 right-2">
                                    <div class="bg-white/80 backdrop-blur-md px-3 py-1.5 rounded-xl inline-flex items-center">
                                        <span class="text-[10px] font-black text-green-800 italic">üìç ${item.desa.replace('Desa.', '')}</span>
                                    </div>
                                </div>
                            </div>
                            <h3 class="text-xs font-bold text-gray-800 line-clamp-2 px-1 leading-tight">${item.nama_produk}</h3>
                        </div>
                        <div class="mt-4 px-1 pb-1">
                            <span class="text-[9px] text-gray-400 font-bold uppercase tracking-wider">Harga</span>
                            <p class="text-base font-black text-orange-500">Rp${parseInt(item.harga_dasar || 0).toLocaleString('id-ID')}</p>
                            <button class="w-full mt-3 bg-gray-900 text-white text-[10px] font-bold py-2.5 rounded-2xl">Detail Produk</button>
                        </div>
                    </div>`;
                    container.insertAdjacentHTML('beforeend', cardHtml);
                });
                currentIndex += limit;
                loader.classList.add('hidden');
            }, 800);
        }

        // FOKUS: Fungsi Toggle Side Sheet
        function toggleSheet() {
            const sheet = document.getElementById('side-sheet');
            const overlay = document.getElementById('sheet-overlay');
            sheet.classList.toggle('sheet-open');
            if(overlay.classList.contains('hidden')){
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.style.opacity = "1", 10);
            } else {
                overlay.style.opacity = "0";
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        // FOKUS: Ganti Wilayah
        function changeRegion(name, url) {
            document.getElementById('current-region').innerText = "Kabupaten " + name;
            currentUrl = url;
            toggleSheet();
            fetchCSV(url);
        }

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && allData.length > 0) renderBatch();
        });
        observer.observe(document.getElementById('sentinel'));

        fetchCSV(currentUrl);
    </script>
</body>
</html>