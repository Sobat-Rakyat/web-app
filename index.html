<!DOCTYPE html>
<html lang="id" class="bg-[#F9FAFB]">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMKM-Desa | Toggle Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            background-color: #F9FAFB !important;
            margin: 0;
            padding: 0;
        }

        .glass-loading {
            position: relative;
            overflow: hidden;
            background-color: #f3f4f6;
            transform: translateZ(0);
        }
        .glass-loading::after {
            content: "";
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0) 100%);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        
        .product-card { 
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
            box-shadow: 0 4px 20px -10px rgba(0,0,0,0.07);
        }
        .product-card:active { transform: scale(0.97); }

        body::-webkit-scrollbar { display: none; }

        #header-wrapper {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }

        /* Animasi untuk area pencarian */
        #search-bar-container {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        #search-bar-container.show {
            max-height: 100px;
            opacity: 1;
            margin-top: 1rem;
        }

        #side-sheet { 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }
        .sheet-open { transform: translateX(0) !important; }

        #sheet-overlay {
            transition: opacity 0.3s ease;
            will-change: opacity;
        }

        #category-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236B7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
        }

        .aspect-3-4 { aspect-ratio: 3 / 4; }
    </style>
</head>
<body class="antialiased font-sans text-gray-900">

    <div id="header-wrapper" class="sticky top-0 z-40 bg-[#F9FAFB] px-5 py-4 border-none shadow-sm">
        <header>
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-black text-green-700 leading-none tracking-tighter">UMKM<span class="text-orange-500">-Desa</span></h1>
                    <p id="current-region" class="text-[10px] text-gray-400 font-bold uppercase tracking-[0.2em] mt-1">Kabupaten Mamuju</p>
                </div>
                <button onclick="toggleSearchBar()" class="text-green-700 p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <svg id="search-icon-svg" class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
            </div>

            <div id="search-bar-container" class="flex gap-2">
                <div class="relative flex-1">
                    <input type="text" id="search-input" oninput="handleSearch()" placeholder="Cari produk desa..." class="w-full bg-white border-2 border-green-700 rounded-2xl py-3 px-10 text-sm focus:ring-2 focus:ring-green-500/20 outline-none transition-all">
                    <svg class="w-4 h-4 absolute left-4 top-4 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <button onclick="toggleSheet()" class="bg-green-700 text-white p-3 rounded-2xl shadow-lg shadow-green-900/20 active:scale-90 transition-transform flex items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                </button>
            </div>
        </header>
    </div>

    <main class="p-4 pb-12">
        <div id="product-container" class="grid grid-cols-2 gap-4"></div>
        <div id="skeleton-loader" class="grid grid-cols-2 gap-4 mt-4">
            <script>
                for(let i=0; i<4; i++){
                    document.write(`<div class="bg-white rounded-[1.8rem] overflow-hidden"><div class="aspect-3-4 glass-loading"></div><div class="p-4"><div class="h-3 glass-loading rounded-full w-3/4 mb-2"></div><div class="h-5 glass-loading rounded-full w-full"></div></div></div>`);
                }
            </script>
        </div>
        <div id="sentinel" class="h-20"></div>
    </main>

    <div id="sheet-overlay" onclick="toggleSheet()" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity"></div>
    <div id="side-sheet" class="fixed top-0 right-0 bottom-0 w-3/4 bg-white z-[60] shadow-2xl transform translate-x-full p-6 flex flex-col">
        <h2 class="text-xl font-black text-gray-800 mb-6 tracking-tight">Filter Wilayah</h2>
        <div class="space-y-3 overflow-y-auto pr-1">
            <button onclick="loadAllProvinces()" class="w-full text-left p-4 rounded-2xl bg-green-700 text-white font-black shadow-lg shadow-green-200 active:scale-95 transition-all">üèÜ Provinsi Sulbar (Semua)</button>
            <button onclick="changeRegion('Mamuju', SOURCES.mamuju)" class="w-full text-left p-4 rounded-2xl bg-gray-50 border border-gray-100 font-bold text-gray-700 active:bg-green-50 active:scale-95 transition-all">üìç Kabupaten Mamuju</button>
            <button onclick="changeRegion('Polman', SOURCES.polman)" class="w-full text-left p-4 rounded-2xl bg-gray-50 border border-gray-100 font-bold text-gray-700 active:bg-green-50 active:scale-95 transition-all">üìç Kabupaten Polman</button>
            <button onclick="changeRegion('Majene', SOURCES.majene)" class="w-full text-left p-4 rounded-2xl bg-gray-50 border border-gray-100 font-bold text-gray-700 active:bg-green-50 active:scale-95 transition-all">üìç Kabupaten Majene</button>
            <hr class="my-4 border-gray-100">
            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Pilih Kategori</label>
            <select id="category-select" onchange="handleCategoryFilter()" class="w-full mt-2 p-4 rounded-2xl bg-gray-100 border-none font-bold text-gray-700 outline-none cursor-pointer">
                <option value="all">Semua Kategori</option>
            </select>
        </div>
        <button onclick="toggleSheet()" class="mt-auto w-full bg-gray-900 text-white py-4 rounded-2xl font-bold active:scale-95 transition-transform">Tutup</button>
    </div>

    <script>
        const IMG_PREFIX = "https://i.ibb.co.com/";
        const SOURCES = {
            mamuju: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSnaM3i5KvBdAtkv2sl5v8W98ncRX2VjLz2lP8w22Iq9LpvZqpFKiAzGvUItbxk6ZdbPUNsB7rRXyoL/pub?gid=0&single=true&output=csv',
            polman: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRGRDIoo5tAGzyJW3K2OfH7J7HS5LBpqLv6GaWQjeALJKNYDk40KK4Yeq-n6WV_gIiqIzDf5SNKQwJZ/pub?gid=0&single=true&output=csv',
            majene: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRh5_1vb_8XGETO0iSzapPY11vhxOw485TzcMQzP7T1FliDp_LvLtE3nuGOvFYuFunvRPKWS6A8uwVY/pub?gid=0&single=true&output=csv'
        };

        let allData = [];
        let filteredData = [];
        let currentIndex = 0;
        const limit = 6;

        const container = document.getElementById('product-container');
        const loader = document.getElementById('skeleton-loader');
        const headerWrapper = document.getElementById('header-wrapper');
        const categorySelect = document.getElementById('category-select');

        // Fungsi Toggle Search Bar
        function toggleSearchBar() {
            const searchBar = document.getElementById('search-bar-container');
            const iconSvg = document.getElementById('search-icon-svg');
            searchBar.classList.toggle('show');
            
            if (searchBar.classList.contains('show')) {
                iconSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path>'; // Ikon X
            } else {
                iconSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>'; // Ikon Lensa
                document.getElementById('search-input').value = '';
                applyFilters();
            }
        }

        let lastScrollTop = 0;
        window.addEventListener('scroll', () => {
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            if (scrollTop > lastScrollTop && scrollTop > 100) headerWrapper.style.transform = 'translateY(-100%)';
            else headerWrapper.style.transform = 'translateY(0)';
            lastScrollTop = scrollTop;
        }, { passive: true });

        function updateCategoryDropdown() {
            const categories = [...new Set(allData.map(item => item.kategori).filter(Boolean))];
            categorySelect.innerHTML = '<option value="all">Semua Kategori</option>';
            categories.sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        }

        async function loadAllProvinces() {
            toggleSheet();
            document.getElementById('current-region').innerText = "Provinsi Sulawesi Barat";
            container.innerHTML = '';
            allData = [];
            currentIndex = 0;
            try {
                const results = await Promise.all(Object.values(SOURCES).map(url => fetch(url).then(res => res.text())));
                results.forEach(csvText => processData(csvText, true));
                updateCategoryDropdown();
                applyFilters();
            } catch (err) { console.error(err); }
        }

        async function fetchCSV(url) {
            container.innerHTML = '';
            allData = [];
            currentIndex = 0;
            try {
                const response = await fetch(url);
                const text = await response.text();
                processData(text);
                updateCategoryDropdown();
                applyFilters();
            } catch (err) { console.error(err); }
        }

        function processData(csvText, isAppend = false) {
            const rows = csvText.split('\n');
            const headers = rows[0].split(',').map(h => h.trim());
            const tempData = [];
            for (let i = 1; i < rows.length; i++) {
                const currentLine = rows[i].split(',');
                if (currentLine.length < headers.length) continue;
                let obj = {};
                headers.forEach((header, index) => {
                    obj[header] = currentLine[index] ? currentLine[index].trim().replace(/^"|"$/g, '') : "";
                });
                tempData.push(obj);
            }
            if (isAppend) allData = [...allData, ...tempData];
            else allData = tempData;
        }

        function applyFilters() {
            const searchQuery = document.getElementById('search-input').value.toLowerCase();
            const categoryQuery = categorySelect.value;
            filteredData = allData.filter(item => {
                const matchSearch = item.nama_produk.toLowerCase().includes(searchQuery) || item.desa.toLowerCase().includes(searchQuery);
                const matchCategory = categoryQuery === 'all' || item.kategori === categoryQuery;
                return matchSearch && matchCategory;
            });
            container.innerHTML = '';
            currentIndex = 0;
            renderBatch();
        }

        function renderBatch() {
            if (currentIndex >= filteredData.length) { loader.classList.add('hidden'); return; }
            loader.classList.remove('hidden');
            setTimeout(() => {
                const chunk = filteredData.slice(currentIndex, currentIndex + limit);
                chunk.forEach(item => {
                    const cardHtml = `
                    <div class="product-card bg-white rounded-[1.8rem] overflow-hidden flex flex-col">
                        <div class="relative aspect-3-4 bg-gray-100 flex flex-col justify-end overflow-hidden">
                            <img src="${IMG_PREFIX}${item.link_thumbnail}" decoding="async" class="absolute inset-0 w-full h-full object-cover">
                            <div class="relative z-10 self-end bg-white pt-1.5 pl-3 rounded-tl-[1rem] flex items-center gap-1.5 translate-y-[1px]">
                                <svg class="w-1.5 h-1.5 text-green-600 mb-[1px]" fill="currentColor" viewBox="0 0 20 20"><path d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/></svg>
                                <span class="text-[7px] font-black text-gray-400 uppercase tracking-tight pr-3 pb-1">${item.desa.replace('Desa.', '')}</span>
                            </div>
                        </div>
                        <div class="p-4 pt-5 flex flex-col flex-1 justify-between">
                            <div>
                                <h3 class="text-[14px] font-semibold text-gray-800 line-clamp-2 leading-tight mb-2 tracking-tight">${item.nama_produk}</h3>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-[8px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">Harga</span>
                                <p class="text-[18px] font-black text-orange-500 leading-none">Rp${parseInt(item.harga_dasar || 0).toLocaleString('id-ID')}</p>
                            </div>
                        </div>
                    </div>`;
                    container.insertAdjacentHTML('beforeend', cardHtml);
                });
                currentIndex += limit;
                loader.classList.add('hidden');
            }, 500);
        }

        function handleSearch() { applyFilters(); }
        function handleCategoryFilter() { applyFilters(); }
        function toggleSheet() {
            const sheet = document.getElementById('side-sheet');
            const overlay = document.getElementById('sheet-overlay');
            sheet.classList.toggle('sheet-open');
            if(overlay.classList.contains('hidden')){
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.style.opacity = "1", 10);
            } else {
                overlay.style.opacity = "0";
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }
        function changeRegion(name, url) {
            document.getElementById('current-region').innerText = "Kabupaten " + name;
            document.getElementById('search-input').value = '';
            toggleSheet();
            fetchCSV(url);
        }
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && filteredData.length > currentIndex) renderBatch();
        });
        observer.observe(document.getElementById('sentinel'));
        fetchCSV(SOURCES.mamuju);
    </script>
</body>
</html>